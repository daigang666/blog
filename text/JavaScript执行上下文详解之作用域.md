# JavaScript执行上下文详解之作用域

执行上下文是JavaScript中一个非常重要的概念，理解了它才能更好的理解JavaScript语言本身以及该语言的一些特性，如变量提升，作用域。

## 作用域
> 作用域指的是程序中变量定义的区域，该位置决定了变量的生命周期，通俗的说就是，作用域是变量和函数的访问范围。作用域控制着变量和函数的可见性和生命周期。

JavaScript在设计时并未想到过这门语言会如此流行，所以只按照最简单的方式来设计，只保留了全局作用域和函数作用域。
- 全局作用域中对象和变量在任何地方都能访问，生命周期等同于页面的生命周期

- 函数作用域是在函数内部定义的变量或函数只能在函数内部被访问。函数执行结束之后，函数内部定义的内部变量会被销毁。

## 变量提升
JavaScript在执行前会先进行编译，编译阶段会将变量和函数存放在执行上下文的变量环境中，值设为undefined。编译完成进入执行阶段，使用变量时从变量环境中读取，在执行变量的赋值代码前，值均为undefined。
变量提升给初学者带来了很多疑惑，有如下问题：
- 变量容易被覆盖而不知
``` js
var name = 'xiaoming';
function showName() {
    console.log(name);
    if (0) {
        var name = 'xiaoli';
    }
    console.log(name);
}
showName();
```
- 本应该销毁的变量没有被销毁
``` js
function fn() {
    for(var i = 0;i < 10; i++ ) {

    }
    console.log(i);
}
fn();
```
## 块级作用域
为了解决变量提升等问题，打造JavaScript为企业级的开发语言，ES6引入了let和const关键字，从而使用JavaScript也能像其他语言一样拥有块级作用域。
我们已经知道JavaScript引擎是通过变量环境实现函数级作用域的，那么ES6又是如何在函数级作用域的基础上，实现对块级作用域的支持呢？我们来看一段代码。
```js
function fn() {
    var a = 1;
    let b = 2;
    {
        let b = 3;
        var c = 4;
        let d = 5;
        console.log(a);
        console.log(b);
    }
    console.log(b);
    console.log(c);
    console.log(d);
}
fn()
```

我们来分析一下这段代码的执行过程：

*第一步是编译并创建执行上下文*，执行上下文如下：
```
            fn函数的执行上下文
    变量环境            词法环境
a：undefined
c：undefined         [ b: undefined ]
```
从上面的结构可以看出：
- 函数内部通过var声明的变量，在编译阶段会被存放到环境变量中。
- 通过let声明的变量，在编译阶段会存放到词法环境中。
- 在函数的作用域内部，通过let声明的变量并没有被存放到词法环境中

*第二步是执行代码*，当执行到函数代码块里面时（第四行），变量环境中的a已经被赋值为了1，词法环境中b的值已经被设置成了2，这时候函数的执行上下文如下所示：
```
            fn函数的执行上下文
    变量环境            词法环境
                    [ 
                        b: undefined 
                        d: undefined
a：1                ]
c：undefined         [ b: undefined ]
```

从上面可以看出，当进入函数的作用域块时，作用域块通过let声明的变量，会被存放在词法环境的一个单独的区域中，这个区域中的变量并不影响作用域块外面的变量，比如在作用域外面声明了变量b，执行到该作用域内部时，他们都是独立的存在，不会互相影响。

其实在词法环境内部，维护了一个小型栈结构，栈底是函数最外层的变量，进入了一个作用域块后，就会把该作用域块内部的变量压到栈顶；当作用域执行完成之后，该作用域的信息就会从栈顶弹出，这就是词法环境的结构。

在接下来，当执行到作用域块中log(a)这行代码时，就需要在词法环境和变量环境中查找变量a的值了，路径为：**沿着词法环境的栈顶向下查询，如果在词法环境中的某个块中查找到了，就直接返回给引擎，如果没有就继续在变量环境中查找**

当作用域块执行结束之后，其内部定义的变量就会从词法环境的栈顶弹出，最终执行上下文结构如下：

```
            fn函数的执行上下文
    变量环境            词法环境
a：1
c：4                 [ b: undefined ]
```
总结一下，块级作用域就是通过词法环境的栈结构来实现的，而变量提升是通过变量环境来实现，通过这两者的结合，JavaScript引擎也就同时支持了变量提升和块级作用域了。
